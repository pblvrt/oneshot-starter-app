#!/bin/bash

# Setup script for GitHub Codespaces
# This script creates the .env.local file with the correct PocketBase URL

set -e

echo "=========================================="
echo "ðŸ”§ Running Codespaces Setup Script"
echo "=========================================="

echo "CODESPACE_NAME: ${CODESPACE_NAME:-not set}"
echo "GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN: ${GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN:-not set}"

# Check if we're in GitHub Codespaces
if [ -n "$CODESPACE_NAME" ] && [ -n "$GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN" ]; then
    echo ""
    echo "ðŸš€ Detected GitHub Codespaces environment"

    # Construct the Codespaces forwarded URL for port 8090 (PocketBase)
    POCKETBASE_URL="https://${CODESPACE_NAME}-8090.${GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN}"

    echo "ðŸ“ Setting VITE_PUBLIC_POCKETBASE_URL to: $POCKETBASE_URL"
else
    echo ""
    echo "ðŸ’» Local development environment detected"
    POCKETBASE_URL="http://localhost:8090"
fi

# Always recreate .env.local file
echo ""
echo "ðŸ“ Creating .env.local..."

cat > .env.local << EOF
# Auto-generated by .devcontainer/setup.sh
# Generated at: $(date)
# PocketBase Configuration

# Client-side URL (browser requests)
VITE_PUBLIC_POCKETBASE_URL=${POCKETBASE_URL}

# Server-side URL (for API routes running in container)
VITE_POCKETBASE_URL=http://pocketbase:8090
EOF

echo ""
echo "âœ… Created .env.local:"
echo "=========================================="
cat .env.local
echo "=========================================="
echo ""
echo "ðŸŽ‰ PocketBase Admin UI will be available at: ${POCKETBASE_URL}/_/"
echo ""
